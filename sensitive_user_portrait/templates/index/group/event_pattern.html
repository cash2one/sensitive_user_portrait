<style type="text/css">
	#event_pattern #domain .input-group-addon{
	    /*font-size: 13px;*/
	    padding-left: 7px;
	    margin-top: -5px;
	}
	#event_pattern #topic_string .input-group-addon{
	    /*font-size: 13px;*/
	    padding-left: 7px;
	    margin-top: -5px;
	}

	#event_pattern #topic_string .col-lg-2{
		width:125px;
		margin-top: 5px;
	}
	#event_pattern #domain .col-lg-2{
		width:125px;
		margin-top: 5px;
	}
</style>

<div id="event_pattern">
  <div class="box col-md-12" style="padding-left:10px;margin-top:0;border: 1px solid #DEDEDE;">
  	<div style="padding-top:10px;padding-left:15px;">
  		<div id="basic">
  			<b class='control-label' style='padding-top:5px;'>事件属性</b>
  			<div style="padding:6px 0px 0px 21px;">
			  <span class="input-group-addon" style="width:50px;border:1px solid white;background-color:white; display:inline-block" id="">关键词</span>
			  <input id="text" type='text' class="form-control" style='width:20%; margin-left:15px;display:inline-block;height:25px'  placeholder='多个词用空格隔开'>
			  <span class="input-group-addon" style="width:75px;border:1px solid white;background-color:white; display:inline-block;margin-left:109px;margin-right:15px;" id="">时间范围</span>
	          <input id="time_start" type='text' class="form-control" style='width:145px;display:inline-block;height:25px'>&nbsp;-&nbsp;
	          <input id="time_end" type='text' class="form-control" style='width:145px;display:inline-block;height:25px'>
			</div>
    </div>

  		<div id="extension" style="float:left;">
	      <label class='control-label'>过滤条件</label>
	      <div class='controls'>
        <div class='col-md-12'   id="domain" style="padding: 5px 0 0 33px;">
              <div class='col-md-4' style="width:100%;margin-left:-22px;margin-bottom:5px;">
                <span class="input-group-addon" style="width:50px;border:1px solid white;background-color:white; display:inline-block;" id="">倾向性</span>
                <select id="politics" class="form-control" style='width:20%; margin-left:15px;display:inline-block;height:25px;padding:1px 12px;'>
                    <option value="">不限</option>
                    <option value="左派">左派</option>
                    <option value="中立">中立</option>
                    <option value="右派">右派</option>
                </select>
              </div>
              <br>

        <span style="float:left;line-height: 27px;margin-right:15px;color: #555555;">领域</span>
              <div class='col-lg-2' style="margin-left:0px;">
                <input type='checkbox' class='inline-checkbox' value='option1' checked='checked'>
                <span class="input-group-addon" style="border:1px solid white;background-color:white; display:inline-block" id="writer">作家写手</span>                             
              </div>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1'>
                <span class="input-group-addon" style="border:1px solid white;background-color:white; display:inline-block" id="professor">专家学者</span>
              </div>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1'>
                <span class="input-group-addon" style="border:1px solid white;background-color:white; display:inline-block" id="root">草根红人</span>
              </div>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1'>
                <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="religion">宗教人士</span>
              </div>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1'>
                <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block;" id="lawyer">维权律师</span>
              </div>
              <div id="domain_show" onclick='event_show_more();' style="font-size:14px;color:#037EAA;cursor: pointer;line-height: 30px;width:100px;margin-left:580px;"><u><b>显示更多</b></u></div>
              <div id="more_domain" class="hidden">
                <div class='col-lg-2' style="margin-left:43px;">
                    <input type='checkbox' class='inline-checkbox' value='option1'>
                    <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block;" id="well-known">公知分子</span>
                </div>
                <div class='col-lg-2' >
                  <input type='checkbox' class='inline-checkbox' value='option1'>
                  <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="non-public">非公企业主</span>
                </div>
                <div class='col-lg-2' >
                  <input type='checkbox' class='inline-checkbox' value='option1'>
                  <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="media">独立媒体人</span>
                </div>
                <div class='col-lg-2' >
                  <input type='checkbox' class='inline-checkbox' value='option1'>
                  <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="official-media">官方媒体</span>
                </div>
                <div class='col-lg-2' >
                    <input type='checkbox' class='inline-checkbox' value='option1'>
                    <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="governer">公职人员</span>
                </div>
                <div class='col-lg-2'  style="margin-left:43px;">
                  <input type='checkbox' class='inline-checkbox' value='option1'>
                  <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="star">文体明星</span>
                </div>
                <div class='col-lg-2' >
                  <input type='checkbox' class='inline-checkbox' value='option1'>
                  <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="welfare">社会公益</span>
                </div>
                <div onclick="event_fold_domain();" style="float: left;line-height: 27px;font-size:14px;color:#037EAA;cursor: pointer;"><u><b>收起</b></u></div>   
              </div>
         </div>
      <div class='cols-md-12' style="padding-left:33px;margin-top: 5px;" id="topic_string">
            <span style="float:left;line-height: 27px;margin-right:15px;color: #555555;">话题</span>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1' checked='checked'>
                <span class="input-group-addon" style="border:1px solid white;background-color:white; display:inline-block" id="fear-of-violence">暴恐</span>
              </div>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1'>
                <span class="input-group-addon" style="border:1px solid white;background-color:white; display:inline-block" id="heresy">邪教</span>
              </div>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1'>
                <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="ideology">意识形态</span>
              </div>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1'>
                <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block" id="livelihood">民生</span>
              </div>
              <div class='col-lg-2'>
                <input type='checkbox' class='inline-checkbox' value='option1'>
                <span class="input-group-addon" style="border:1px solid white; background-color:white;display:inline-block;" id="religion">宗教</span>
              </div>
            </div>
	        <div class='col-md-12' style='padding:0px;margin-left: -5px;'>
            <div class='col-lg-4' >
                <span class="input-group-addon" style="width:65px;border:1px solid white;float:left;background-color:white;display:inline-block">人数</span>
                <span style="float: left;"><input style='width:85%;' type='range' id='num-range' min='0' max='200' step='20' value='100' class='inline-checkbox'>
                    0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;200
                </span>
                <span id="show_num" style="border-radius: 4px;margin-left: -6px;padding: 5px;border: 1px solid #ccc;">100</span>
            </div>
	          <div class='col-lg-4' >
	            <span class="input-group-addon" style="width:75px;border:1px solid white;float:left;background-color:white;display:inline-block">影响力</span>
	            <input id="influ_from" type='text' class="form-control" style='width:25%; display:inline-block;height:25px'  value='50'>&nbsp;-&nbsp;
	            <input id="influ_to" type='text' class="form-control" style='width:25%; display:inline-block;height:25px'  value='100'>
	          </div>
	          <div class='col-lg-4' style='margin-left:15px;width:244px;padding-right:0px;'>
	            <span class="input-group-addon" style="width:75px;border:1px solid white;float:left;background-color:white;display:inline-block">重要度</span>
	            <input id="impor_from" type='text' class="form-control" style='width:25%; display:inline-block;height:25px'  value='50'>&nbsp;-&nbsp;
	            <input id="impor_to" type='text' class="form-control" style='width:25%; display:inline-block;height:25px'  value='100'>
	          </div>
	        </div>
	      </div>
	    </div>
        <hr style='width:750px;margin-bottom:0px;'>
        <div id="information" class="col-md-12" style="padding-top:5px;padding-left:0px;">
          <label class='control-label'>群组信息</label>
          <div class='controls'>
            <div class='col-md-12' style='padding:0px;margin-left: 5px;'>
              <div class='col-lg-6' style='padding:0px;width:48%;'>
                 <span style='float:left;color:#c00;font-size:15px;margin-top:5px;'>*</span>
                 <span class="input-group-addon" style="width:70px;padding-right:0px;border:1px solid white;float:left;background-color:white;display:inline-block">名称</span>
                <input id="first_name" type='text' class="form-control" style='width:78%; display:inline-block;height:25px;padding-left: 5px;' placeholder='（必填）仅包含汉字、英文、数字和下划线'>
              </div>
              <div class='col-lg-6' style='padding:0px;'>
                <span class="input-group-addon" style="margin-left:15px;width:75px;border:1px solid white;float:left;background-color:white;display:inline-block">备注</span>
                <input id="first_remarks" type='text' class="form-control" style='width:76%; display:inline-block;height:25px;padding-left: 5px;' placeholder='（选填）仅包含汉字、英文、数字和下划线'>
              </div>
            </div>
          </div>
        </div>
        <div class="cols" style='margin:11px 0px;'>
          <div class='col-md-12' style='text-align:right; padding-right:98px;height: 30px;'>
            <span id="event_pattern_commit" onclick="submit_event();" class="label label-success" style='cursor:pointer; background-color:rgba(69, 133, 195, 0.89);margin-bottom:10px;'>提交</span>
          </div>
        </div>
	</div>
  </div>
</div>

<script type="text/javascript">
  function event_show_more(){
      $("#event_pattern #more_domain").removeClass("hidden");
      $("#event_pattern #domain_show").addClass("hidden");
  }
  function event_fold_domain(){
      $("#event_pattern #more_domain").addClass("hidden");
      $("#event_pattern #domain_show").removeClass("hidden");
  }
  function event_show_more_topic(){
      $("#event_pattern #more_topic").removeClass("hidden");
      $("#event_pattern #topic_show").addClass("hidden");
  }
  function event_fold_topic(){
      $("#event_pattern #more_topic").addClass("hidden");
      $("#event_pattern #topic_show").removeClass("hidden");
  }


//日期选择
var date = choose_time_for_mode();
var min_date_ms = new Date()
date.setHours(0,0,0,0);
var current_date = date.format('yyyy/MM/dd hh:mm');
var from_date_time = Math.floor(date.getTime()/1000) - 60*60*24;
min_date_ms.setTime(from_date_time*1000);
var from_date = min_date_ms.format('yyyy/MM/dd hh:mm');
if (global_test_mode == 0){
    $('#event_pattern #time_start').datetimepicker({value:from_date,step:10});
    $('#event_pattern #time_end').datetimepicker({value:current_date,step:10});
}
else{
    $('#event_pattern #time_start').datetimepicker({value:from_date,step:10,minDate:'-1970/01/30',maxDate:'+1970/01/01'});
    $('#event_pattern #time_end').datetimepicker({value:current_date,step:10,minDate:'-1970/01/30',maxDate:'+1970/01/01'});
}    
$('#event_pattern #num-range').change(function(){
    var num = $('#event_pattern #num-range').val();
    $('#event_pattern #show_num').empty();
    $('#event_pattern #show_num').append(num);    
});

function event_pattern_check(){             // check validation 
  //group_information check starts  
  var dt = new Date();
  dt.setHours(0,0,0,0);
  //console.log('max_date_limit',max_date_limit);
  var max_date_limit_stamp = Date.parse(dt)/1000;
  var group_name = $('#event_pattern #first_name').val();
  var remark = $('#event_pattern #first_remarks').val();
  var location = $('#event_pattern #location').val();
  var time_from = Date.parse($('#event_pattern #time_start').val())/1000;
  var time_to = Date.parse($('#event_pattern #time_end').val())/1000;
  var num_range_count = $('#event_pattern #num-range').val();
  var influ_from_num = parseFloat($('#event_pattern #influ_from').val());
  var influ_to_num =parseFloat($('#event_pattern #influ_to').val());
  var impor_from_num = parseFloat($('#event_pattern #impor_from').val());
  var impor_to_num = parseFloat($('#event_pattern #impor_to').val());
  if (influ_from_num > influ_to_num){
    alert('影响力左侧输入值应小于右侧，请重新输入！')
    return false;
  }
  if (impor_from_num > impor_to_num){
    alert('重要度输入栏左侧输入值应小于右侧，请重新输入！')
    return false;
  }
  if(influ_from_num > 100 || influ_to_num > 100){
    alert('影响力输入值应在0到100之间，请重新输入！');
    return false;
  }
  if(impor_from_num>100 || impor_to_num>100){
    alert('重要度输入值应在0到100之间，请重新输入！');
    return false;
  }
  if(num_range_count ==0 ){
    alert('扩展规则中人数不能为0，请重新输入！');
    return false;
  }
  if(time_from > time_to){
    alert('起止时间错误，请重新选择！');
    return false;
  }
  if(max_date_limit_stamp < time_to ){
    alert('终止时间最晚不超过今日零点，请重新选择！');
    return false;
  }
  if (group_name.length == 0){
      alert('群体名称不能为空，请重新输入！');
      return false;
  }

  var reg = "^[a-zA-Z0-9_\u4e00-\u9fa5\uf900-\ufa2d]+$";
  if (!group_name.match(reg)){
    alert('群体名称只能包含英文、汉字、数字和下划线,请重新输入!');
    return false;
  }
  if ((remark.length > 0) && (!remark.match(reg))){
    alert('备注只能包含英文、汉字、数字和下划线,请重新输入!');
    return false;
  }
  //other form check starts multi/single
  return true;

}

function submit_event(){
	if(event_pattern_check()){
		var event_pattern_url = '/detect/event/?';
		var event_all_url = new Array();

		var text_url = '';
		var text_id = $('#event_pattern #text').attr("id");
		var text_content = $('#event_pattern #text').val();
		if(text_content != ''){
			text_url = text_id +'='+ text_content;
			event_all_url.push(text_url);
		}

		var time_from = Date.parse($('#event_pattern #time_start').val())/1000;
		var time_to = Date.parse($('#event_pattern #time_end').val())/1000;
		var timestamp_from_url = '';
		timestamp_from_url = 'timestamp_from=' + time_from;
		event_all_url.push(timestamp_from_url);
		var timestamp_to_url = '';
		timestamp_to_url = 'timestamp_to=' + time_to;
		event_all_url.push(timestamp_to_url);

      var politics_id = $('#event_pattern #politics').attr("id");
      var politics_content = $('#event_pattern #politics').val();
      if(politics_content != ''){
        politics_url = politics_id +'='+ politics_content;
        event_all_url.push(politics_url);
      }

      	var domain_url = '';
		var domain = new Array();
		$('#event_pattern #domain .inline-checkbox').each(function(){
        	if($(this).is(':checked')){
          		domain.push($(this).next().text());
        	}
      	});
      	if(domain.length != 0 ){
       		domain_url += 'domain=' + domain.join(',');
        	event_all_url.push(domain_url);
      	}
      
		var topic_url = '';
		var topic_string = new Array();
		$('#event_pattern #topic_string .inline-checkbox').each(function(){
			if($(this).is(':checked')){
		  		topic_string.push($(this).next().text());
			}
		});
		if(topic_string.length != 0){
			topic_url += 'topic_string=' + topic_string.join(',');
			event_all_url.push(topic_url);
		}

		var num_range_url = '';
		var num_range_count = $('#event_pattern #num-range').val();
		num_range_url = 'count=' + num_range_count;
		event_all_url.push(num_range_url);

		var influ_from_url ='';
		var influ_from_val = $('#event_pattern #influ_from').val();
		influ_from_url = 'influence_from=' + influ_from_val;
		event_all_url.push(influ_from_url);

		var influ_to_url ='';
		var influ_to_val = $('#event_pattern #influ_to').val();
		influ_to_url = 'influence_to=' + influ_to_val;
		event_all_url.push(influ_to_url);

		var important_from_url ='';
		var important_from_val = $('#event_pattern #impor_from').val();
		important_from_url = 'important_from=' + important_from_val;
		event_all_url.push(important_from_url);

		var important_to_url ='';
		var important_to_val = $('#event_pattern #impor_to').val();
		important_to_url = 'important_to=' + important_to_val;
		event_all_url.push(important_to_url);

		var task_name_url = ''
		var task_name_id = 'task_name'
		var task_name_content = $('#event_pattern #first_name').val();
		if(task_name_content != ''){
		task_name_url =task_name_id +'='+ task_name_content;
		event_all_url.push(task_name_url);
		}

		var first_remarks_url = ''
		var first_remarks_id = 'state'
		var first_remarks_content = $('#event_pattern #first_remarks').val();
		if(first_remarks_content != ''){
		first_remarks_url = first_remarks_id +'='+ first_remarks_content;
		event_all_url.push(first_remarks_url);
		}


		event_pattern_url += event_all_url.join('&') + '&submit_user=' + submit_user ;
		console.log(event_pattern_url);
	
		$.ajax({
			type:'GET',
			url: event_pattern_url,
			contentType:"application/json",
			dataType: "json",
			success: event_callback
      });
      
    }	
	}
  function event_callback(data){
    console.log(data);
    if (data == true){
      //redraw_result();
      alert('提交成功！');
      window.location.reload(); 
    } 
    if(data == 'invalid input for query'){
      alert('请至少选择一个筛选条件！')
    }
    if(data =='task name invalid'){
        alert('已存在相同名称的群体分析任务,请重试!');
    }
    if(data =='invalid input for range'){
      alert('请选择合理的时间范围！');
    }
    if(data == 'invalid input for filter'){
      alert('请输入合理的影响力或重要度范围！');
    }
    if(data == 'invalid input for count'){
      alert('请选择合理的人数！')
    }

      }
</script>
